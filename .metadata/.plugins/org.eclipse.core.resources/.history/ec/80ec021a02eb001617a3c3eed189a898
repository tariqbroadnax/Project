package GUI;

import java.awt.Dimension;
import java.awt.Font;
import java.awt.FontMetrics;

import javax.swing.JTextArea;
import javax.swing.Timer;
import javax.swing.event.DocumentEvent;
import javax.swing.text.DefaultCaret;

import Dialogue.Dialogue;
import EditorGUI.SimpleDocumentListener;

public class DialogueArea extends JTextArea
	implements SimpleDocumentListener
{
	private static final int CHARS_PER_SEC = 20;
	
	private Dialogue dialogue;
	
	private Timer timer;
	
	private long start;

	public DialogueArea()
	{
		timer = new Timer(33, e -> updateText());
	
		setLineWrap(true);
		setWrapStyleWord(true);
		setEditable(false);
		
		Font font = new Font("Consolas", Font.PLAIN, 20);
		
		setFont(font);	
		
		DefaultCaret caret = (DefaultCaret) getCaret();
		caret.setUpdatePolicy(DefaultCaret.ALWAYS_UPDATE); 

		setPreferredSize(new Dimension(400, 100));
	}
	
	private void updateText()
	{
		long elapsed = System.currentTimeMillis() - start;
		
		int visChars = (int)(elapsed / 1000.0 * CHARS_PER_SEC);
	
		String txt = dialogue.getText();
		
		if(txt.length() < visChars)
		{
			setText(txt);
			
			timer.stop();
		}
		else
		{
			String substr = txt.substring(0, visChars);
			setCaretPosition(getDocument().getLength());
			setText(substr);
		}		
	}

	public void setDialogue(Dialogue dialogue)
	{
		this.dialogue = dialogue;
	
		start = System.currentTimeMillis();
		
		timer.start();
	}
	
	private int maxLines()
	{
		FontMetrics metrics = getGraphics()
							 .getFontMetrics();
		
		int height = getHeight(),
			txtHeight = metrics.getHeight();
		
		return height / txtHeight;
	}

	@Override
	public void documentChanged(DocumentEvent e) 
	{
		int lines = getLineCount(),
			maxLines = maxLines();
	}
}
