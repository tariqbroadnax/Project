package Editor;

import java.awt.Color;
import java.awt.Point;
import java.awt.event.MouseEvent;
import java.awt.geom.Point2D;
import java.awt.geom.Rectangle2D;

import javax.swing.SwingUtilities;

import Editor.layer_selector.SetTile;
import EditorGUI.UndoManager;
import Graphic.Camera;
import Graphic.GraphicsContext;
import Graphic.ShapeGraphic;
import Maths.Dimension2D;
import Tileset.Tile;
import Tileset.TileMap;

public class TileTransferHandler 
	extends SelectionTransferHandler
{
	private Tile tile;
	
	private EditorResources resources;
			
	private Camera camera;
	
	private UndoManager undoManager;
	
	private Point mouseLoc;
	
	public TileTransferHandler(
			EditorResources resources,
			Camera camera,
			UndoManager undoManager) 
	{	
		this.resources = resources;
		this.undoManager = undoManager;
	}

	@Override
	public boolean setSelection(Object obj) 
	{
		if(obj instanceof Tile)
		{
			tile = (Tile) obj;
			return true;
		}
		else
			return false;
	}

	private void importSelection() 
	{
		Point2D.Double normLoc = camera.normalLocation(mouseLoc);

		TileMap tm = resources.scene.getTileMap();

		int row = tm.row(normLoc.y),
			col = tm.col(normLoc.x);
		
		if(0 <= row && row < tm.rows && 
		   0 <= col && col < tm.cols)
		{
			SetTile edit = new SetTile(resources, tm, tile, row,  col);
			
			edit.invoke();
			undoManager.addEdit(edit);
		}
	}
	
	private void removeTile()
	{
		
	}

	@Override
	public void paintSelection(GraphicsContext gc) 
	{		
		Point2D.Double normLoc = camera.normalLocation(mouseLoc);
		
		TileMap tm = resources.scene.getTileMap();
		
		int row = tm.row(normLoc.y),
			col = tm.col(normLoc.x);
			
			if(!(0 <= row && row < tm.rows && 
			     0 <= col && col < tm.cols))
				return;
			
			double x = tm.x(col), y = tm.y(row);

			Dimension2D.Double tileSize = tm.tileSize();
		
			Rectangle2D.Double tileBound =
					new Rectangle2D.Double(
							0, 0, tileSize.width, 
								  tileSize.height);
		
			ShapeGraphic shape = new ShapeGraphic();
			
			shape.setLoc(x + tileSize.width/2, 
						 y + tileSize.height/2);
			
			shape.setShape(tileBound);
			
			Color selectionColor = new Color(0, 0, 255, 120);
			shape.setPaint(selectionColor);
			
			shape.paint(gc);
	}
	
	@Override
	public void mousePressed(MouseEvent e)
	{
		mouseLoc = e.getPoint();

		if(SwingUtilities.isLeftMouseButton(e))
			importSelection();
		else if(SwingUtilities.isRightMouseButton(e))
		{
			
		}
	}
	
	public void mouseMoved(MouseEvent e)
	{
		mouseLoc = e.getPoint();
	}
	
	@Override
	public void mouseDragged(MouseEvent e)
	{
		mouseLoc = e.getPoint();

		if(SwingUtilities.isLeftMouseButton(e))
			importSelection();
		else if(SwingUtilities.isRightMouseButton(e))
		{
			
		}
	}
}